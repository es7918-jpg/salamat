<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>سلامت – کانال ایتا</title>
  <style>
    body{font-family:Tahoma,Arial,sans-serif;background:#f6f7fb;color:#0f172a;margin:0}
    header{padding:12px 16px;background:#fff;border-bottom:1px solid #e5e7eb;position:sticky;top:0}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;min-width:240px}
    button{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    .muted{color:#64748b;font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:640px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .thumb{width:100%;border-radius:8px}
    .err{background:#fef2f2;border-color:#fecaca;color:#991b1b;padding:12px;border-radius:12px;border:1px solid #fecaca}
    a{color:#0369a1;text-decoration:none}
  </style>
</head>
<body>
<header class="wrap">
  <div class="row">
    <strong style="font-size:18px">پست‌های کانال ایتا</strong>
    <input id="slug" value="bedasht_ravan" />
    <button id="btn">بارگذاری</button>
  </div>
  <div class="muted" style="margin-top:6px">
    اگر سفیده بود، این‌ها را جدا باز کن:
    1) https://r.jina.ai/https://eitaa.com/s/bedasht_ravan
    2) https://r.jina.ai/https://eitaa.com/bedasht_ravan
  </div>
</header>

<main id="out" class="wrap">
  <p class="muted">برای شروع روی «بارگذاری» بزنید.</p>
</main>

<script>
(function(){
  var out  = document.getElementById('out');
  var btn  = document.getElementById('btn');
  var slugEl = document.getElementById('slug');

  function fetchText(url, cbOk, cbErr){
    var x = new XMLHttpRequest();
    x.open('GET', url, true);
    x.onreadystatechange = function(){
      if(x.readyState === 4){
        if(x.status >= 200 && x.status < 300) cbOk(x.responseText);
        else cbErr(new Error('fetch '+url+' -> '+x.status));
      }
    };
    x.send();
  }

  function stripTags(s){
    return String(s).replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim();
  }

  function uniq(arr){
    var m = {}; var out = [];
    for (var i=0;i<arr.length;i++){ var k = arr[i]; if(!m[k]){ m[k]=1; out.push(k); } }
    return out;
  }

  function extractPosts(html, slug, limit){
    var re = new RegExp('/'+slug.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'/(\\d+)', 'g');
    var ids = []; var m;
    while((m = re.exec(html)) !== null){ ids.push(m[1]); }
    ids = uniq(ids).slice(0, limit || 24);

    var items = [];
    for (var i=0;i<ids.length;i++){
      var id = ids[i];
      var mark = '/'+slug+'/'+id;
      var idx = html.indexOf(mark);
      var win = idx>=0 ? html.slice(Math.max(0, idx-1600), Math.min(html.length, idx+1600)) : '';
      var parts = win.split('</a>');
      var text  = stripTags(parts.length ? parts[parts.length-1] : '').slice(0,180);

      var cover = '';
      var m1 = win.match(/https?:\/\/[^"'<>\s]+?\.(jpg|jpeg|png|gif)/i);
      if(m1 && m1[0]) cover = m1[0];
      if(!cover){
        var m2 = win.match(/https?:\/\/[^"'<>\s]+\/download\/[^"'<>\s]+/i);
        if(m2 && m2[0]) cover = m2[0];
      }

      items.push({ id:id, link:'https://eitaa.com/'+slug+'/'+id, text:text, cover:cover });
    }
    return items;
  }

  function renderError(msg){
    out.innerHTML = '';
    var d = document.createElement('div');
    d.className = 'err';
    d.appendChild(document.createTextNode('خطا: '+msg));
    out.appendChild(d);
  }

  function renderPosts(items){
    out.innerHTML = '';
    var grid = document.createElement('div');
    grid.className = 'grid';
    out.appendChild(grid);

    for (var i=0;i<items.length;i++){
      var p = items[i];
      var card = document.createElement('article');
      card.className = 'card';
          if(p.cover){
        var img = document.createElement('img');
        img.className = 'thumb';
        img.src = p.cover;
        img.alt = '';
        card.appendChild(img);
      }

      var idline = document.createElement('div');
      idline.className = 'muted';
      idline.appendChild(document.createTextNode('#'+p.id));
      card.appendChild(idline);

      var para = document.createElement('p');
      para.appendChild(document.createTextNode(p.text));
      card.appendChild(para);

      var a = document.createElement('a');
      a.href = p.link;
      a.target = '_blank';
      a.rel = 'noopener';
      a.appendChild(document.createTextNode('مشاهده در ایتا'));
      card.appendChild(a);

      grid.appendChild(card);
    }
  }

  function load(){
    var slug = slugEl.value.replace(/\s+/g,'').trim();
    if(!slug){ renderError('اسلاگ خالی است'); return; }
    out.innerHTML = '<p class="muted">در حال بارگذاری…</p>';

    // اول /s/<slug>
    var urlS = 'https://r.jina.ai/https://eitaa.com/s/'+encodeURIComponent(slug);
    fetchText(urlS, function(htmlS){
      var items = extractPosts(htmlS, slug, 24);
      if(items.length){ renderPosts(items); return; }
      // فالبک: /<slug>
      var urlP = 'https://r.jina.ai/https://eitaa.com/'+encodeURIComponent(slug);
      fetchText(urlP, function(htmlP){
        var items2 = extractPosts(htmlP, slug, 24);
        if(items2.length){ renderPosts(items2); }
        else renderError('هیچ پستی پیدا نشد. کانال باید عمومی باشد و URL پست‌ها به صورت https://eitaa.com/'+slug+'/123 بیاید.');
      }, function(err2){ renderError(err2.message); });
    }, function(err1){
      renderError(err1.message);
    });
  }

  btn.addEventListener('click', load);
})();
</script>
</body>
</html>
