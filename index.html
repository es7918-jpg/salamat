<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>شبکه سلامت – نسخه بله</title>
  <style>
    body{font-family:tahoma,arial,sans-serif;background:#f7fafc;color:#111;max-width:900px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px}
    .muted{color:#6b7280;font-size:12px}
    .tabs{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:space-around;padding:10px}
    .tabbtn{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:8px 14px;cursor:pointer}
    .tabbtn.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    main{padding-bottom:72px}
    .pill{display:inline-block;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:8px 12px;margin:6px 6px 0 0;cursor:pointer}
    .pill.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:10px 0}
    .title{font-weight:700;margin:4px 0}
    .cap{font-size:13px;color:#374151;line-height:1.9;white-space:pre-wrap}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    a.btn{font-size:12px;text-decoration:none;background:#0ea5e9;color:#fff;padding:6px 10px;border-radius:999px}
    input.search{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  </style>
</head>
<body>
  <h1>شبکه سلامت</h1>
  <div class="muted">نسخه آزمایشی – بله</div>

  <main id="app"></main>

  <nav class="tabs">
    <button class="tabbtn" data-tab="home">خانه</button>
    <button class="tabbtn" data-tab="explore">اکسپلور</button>
    <button class="tabbtn" data-tab="search">جستجو</button>
    <button class="tabbtn" data-tab="about">درباره ما</button>
  </nav>

  <script>
  var API = "https://script.google.com/macros/s/AKfycbzfsN3oMUFRdpmDp4Ghada9l7sJokOaG2iWvYPaWPH3IB0QaRHhpeTaPCXG3gxSlJVQgw/exec";

  var CATS = [
    { key:"mental",    title:"سلامت روان" },
    { key:"nutrition", title:"تغذیه" },
    { key:"dental",    title:"دهان و دندان" },
    { key:"disease",   title:"بیماری‌ها" },
    { key:"family",    title:"سلامت خانواده" }
  ];

  var state = { tab:"home", activeCat:null, lists:{}, explore:[], searchPool:[], q:"" };
  var app = document.getElementById("app");

  function xhrGet(url, cb){
    var x=new XMLHttpRequest(); x.open("GET",url,true);
    x.onreadystatechange=function(){ if(x.readyState===4){ cb(null,x); } }; x.send(null);
  }
  function esc(s){ s=s||""; return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }

  function fetchChannel(cat, cb){
    xhrGet(API+"?cat="+encodeURIComponent(cat), function(err,x){
      if(err || x.status!==200){ cb(err||new Error("API "+x.status)); return; }
      try{ cb(null, JSON.parse(x.responseText).items || []); }catch(e){ cb(e); }
    });
  }

  function render(){
    var html="";
    if(state.tab==="home"){
      if(!state.activeCat){
        html+="<h2>دسته‌ها</h2><div>";
        for(var i=0;i<CATS.length;i++){ var c=CATS[i]; html+='<span class="pill" data-gocat="'+c.key+'">'+c.title+'</span>'; }
        html+="</div>";
        app.innerHTML=html;
      }else{
        var key=state.activeCat, posts=state.lists[key]||[];
        html+='<button class="tabbtn" data-back="1">← بازگشت</button><h2>'+getCatTitle(key)+'</h2>';
        html+=renderPosts(posts);
        app.innerHTML=html;
      }
    }else if(state.tab==="explore"){ html+=renderPosts(state.explore); app.innerHTML=html; }
    else if(state.tab==="search"){
      html+='<input class="search" placeholder="جستجو…" value="'+esc(state.q)+'" id="qinp">';
      var results=[];
      if(state.q){ var ql=state.q.toLowerCase();
        for(var i=0;i<state.searchPool.length;i++){ var p=state.searchPool[i];
          var t=(p.title||"")+" "+(p.caption||""); if(t.toLowerCase().indexOf(ql)!==-1) results.push(p);
        }
        html+='<div class="muted">'+results.length+' نتیجه</div>';
      }
      html+=renderPosts(results); app.innerHTML=html;
      var qinp=document.getElementById("qinp"); if(qinp){ qinp.oninput=function(){ state.q=qinp.value; render(); }; }
    }else if(state.tab==="about"){
      app.innerHTML="<h2>درباره ما</h2><p class='cap'>این نسخه آزمایشی است.</p>";
    }

    var btns=document.querySelectorAll(".tabbtn");
    for(var j=0;j<btns.length;j++){ var t=btns[j].getAttribute("data-tab");
      if(t){ btns[j].className="tabbtn"+(t===state.tab?" active":""); } }
    app.onclick=function(e){ var k=e.target.getAttribute("data-gocat"); if(k){ state.activeCat=k; if(!state.lists[k]) loadCat(k); render(); }
      if(e.target.getAttribute("data-back")){ state.activeCat=null; render(); } };
  }

  function renderPosts(list){ var html=""; for(var i=0;i<list.length;i++){ var p=list[i];
    html+='<div class="card"><div class="title">'+esc(p.title||("پست #"+p.id))+'</div>'
        +'<div class="cap">'+esc(p.caption||"")+'</div>'
        +'<div class="row"><a class="btn" href="'+p.link+'" target="_blank">مشاهده</a></div></div>'; }
    return html; }

  function getCatTitle(k){ for(var i=0;i<CATS.length;i++) if(CATS[i].key===k) return CATS[i].title; return k; }

  function loadCat(key){ fetchChannel(key,function(err,items){ if(!err){ state.lists[key]=items; render(); } }); }
  function loadExplore(){ var keys=CATS.map(c=>c.key), all=[]; var pending=keys.length;
    for(var i=0;i<keys.length;i++){ (function(k){ fetchChannel(k,function(err,items){
      if(!err){ for(var j=0;j<items.length;j++){ items[j].cat=k; all.push(items[j]); } }
      pending--; if(pending===0){ state.explore=all; state.searchPool=all; if(state.tab!=="home") render(); } }); })(keys[i]); } }

  var tabBtns=document.querySelectorAll(".tabs .tabbtn");
  for(var i=0;i<tabBtns.length;i++){ tabBtns[i].onclick=function(){ var t=this.getAttribute("data-tab"); state.tab=t;
    if(t==="explore"&&state.explore.length===0) loadExplore();
    if(t==="search"&&state.searchPool.length===0) loadExplore(); render(); }; }

  render();
  </script>
</body>
</html>
