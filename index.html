<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>شبکه سلامت</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --acc:#22d3ee;
    --chip:#1f2937; --chipText:#cbd5e1; --ring:#334155;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:iransans,tahoma,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{padding:18px 16px 8px}
  h1{margin:0 0 4px;font-size:24px}
  .muted{color:var(--muted);font-size:13px}
  main{padding:0 12px 90px}
  /* tabs */
  .tabs{position:fixed;left:0;right:0;bottom:0;background:#0b1220;border-top:1px solid var(--ring);display:flex;gap:10px;justify-content:space-around;padding:10px 12px;backdrop-filter:blur(6px)}
  .tabbtn{flex:1;max-width:140px;border:1px solid var(--ring);border-radius:14px;padding:10px 12px;text-align:center;background:#0b1220;color:var(--text);cursor:pointer}
  .tabbtn.active{background:var(--acc);color:#02131a;border-color:var(--acc);font-weight:600}
  /* chips */
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
  .chip{background:var(--chip);border:1px solid var(--ring);color:var(--chipText);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
  .chip.active{background:var(--acc);color:#00323c;border-color:transparent}
  /* grid */
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media(min-width:700px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }
  .card{position:relative;background:var(--card);border:1px solid var(--ring);border-radius:14px;overflow:hidden}
  .thumb{aspect-ratio:1/1;width:100%;display:block;object-fit:cover;background:
      radial-gradient(120px 120px at 20% 20%, #1f2937, transparent),
      linear-gradient(135deg,#0ea5e9,#22d3ee 50%,#38bdf8)}
  .badge{position:absolute;left:8px;top:8px;background:#0b1220cc;border:1px solid var(--ring);color:var(--chipText);padding:4px 8px;border-radius:10px;font-size:12px}
  .ctxt{padding:10px}
  .title{font-size:14px;font-weight:700;margin:2px 0 6px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .row{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px}
  .btn{display:inline-block;text-decoration:none;background:var(--acc);color:#00141a;padding:7px 10px;border-radius:10px;font-weight:600;border:0}
  .tag{background:#0b1220;border:1px solid var(--ring);padding:4px 8px;border-radius:8px;font-size:12px;color:var(--chipText)}
  .center{display:flex;align-items:center;justify-content:center;padding:40px 0;color:var(--muted)}
  input.search{width:100%;padding:12px 14px;border-radius:12px;background:#0b1220;border:1px solid var(--ring);color:var(--text)}
  /* modal */
  .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .modal-card{max-width:720px;width:100%;background:#0b1220;border:1px solid var(--ring);border-radius:16px;overflow:hidden}
  .modal-body{padding:14px}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--ring)}
  .x{background:#1f2937;border:1px solid var(--ring);color:#cbd5e1;border-radius:10px;padding:6px 10px;cursor:pointer}
</style>
</head>
<body>
  <header>
    <h1>شبکه سلامت</h1>
    <div class="muted">نسخه آزمایشی – اتصال به تلگرام</div>
  </header>
  <main id="app"></main>

  <nav class="tabs">
    <button class="tabbtn" data-tab="home">خانه</button>
    <button class="tabbtn" data-tab="explore">اکسپلور</button>
    <button class="tabbtn" data-tab="search">جستجو</button>
    <button class="tabbtn" data-tab="about">درباره ما</button>
  </nav>
<!-- modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong>جزئیات پست</strong>
        <button class="x" id="xbtn">بستن</button>
      </div>
      <div class="modal-body" id="mbody"></div>
    </div>
  </div>

<script>
// === تنظیم API ===
const API_URL = "«https://script.google.com/macros/s/AKfycbwL163LePEwdXHl0_jwfgirHgn9biiXNwxAF9keLodHmlePXNnVhSFqFzXez5uHjFAIMg/exec»"; : 
// ساختار انتظار: {items:[{id,date,title,caption,tags[],link,thumb?}]}

const CAT_TITLES = {
  "سلامت_روان":"سلامت روان",
  "تغذیه":"تغذیه",
  "دهان_و_دندان":"دهان و دندان",
  "بیماری‌ها":"بیماری‌ها",
  "خانواده":"سلامت خانواده",
  "متفرقه":"متفرقه"
};
const CAT_KEYS = Object.keys(CAT_TITLES);

const state = { tab:"explore", q:"", items:[], byCat:{} };

const app = document.getElementById('app');
const modal = document.getElementById('modal');
const mbody = document.getElementById('mbody');
document.getElementById('xbtn').onclick=()=> modal.classList.remove('show');

function esc(s){ return (s||"").replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' })[m]); }
function fmtDate(ts){
  try{ const d=new Date(ts); return d.toLocaleString('fa-IR',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
  catch{ return ""; }
}
function tagToCat(tags){
  // اولویت با هشتگ‌های مشخص؛ اگر نبود، متفرقه
  const map = {
    "سلامت_روان":"سلامت_روان",
    "تغذیه":"تغذیه",
    "دهان_و_دندان":"دهان_و_دندان",
    "بیماری‌ها":"بیماری‌ها",
    "خانواده":"خانواده"
  };
  for(const t of (tags||[])){
    const k = t.replace(/^#+/,'');
    if(map[k]) return map[k];
  }
  return "متفرقه";
}

function render(){
  // تب‌ها را اکتیو کن
  document.querySelectorAll('.tabbtn').forEach(b=>{
    const t=b.getAttribute('data-tab'); b.classList.toggle('active', t===state.tab);
  });

  if(state.tab==='home'){
    let html='';
    // چیپ‌های دسته‌ها
    html+='<div class="chips">';
    CAT_KEYS.concat('متفرقه').forEach(k=>{
      html+=<span class="chip" data-gocat="${k}">${CAT_TITLES[k]||k}</span>;
    });
    html+='</div>';
    html+='<div class="grid" id="homeGrid"></div>';
    app.innerHTML=html;

    const g=document.getElementById('homeGrid');
    const activeCat = state.activeCat || 'متفرقه';
    const list = (state.byCat[activeCat]||[]);
    g.innerHTML = list.map(cardHTML).join('') || <div class="center">چیزی نیست…</div>;
  }
  else if(state.tab==='explore'){
    app.innerHTML = <div class="grid" id="xp"></div>;
    document.getElementById('xp').innerHTML = state.items.map(cardHTML).join('') || <div class="center">در حال بارگذاری…</div>;
  }
  else if(state.tab==='search'){
    app.innerHTML = <input class="search" id="q" placeholder="جستجو در عنوان/کپشن…"><div class="grid" id="res"></div>;
    const q=document.getElementById('q');
    q.value=state.q||"";
    q.oninput=()=>{ state.q=q.value; doSearch(); };
    doSearch();
  }
  else{
    app.innerHTML = 
      <div class="center" style="flex-direction:column;gap:8px;text-align:center">
        <div>این نمونه‌ی آزمایشی، پست‌های کانال تلگرام شما را نشان می‌دهد.</div>
        <div class="muted">هشتگ‌ها دسته‌بندی می‌سازند؛ اکسپلور همه را در هم نشان می‌دهد.</div>
      </div>;
  }

  // کلیک‌ها
  app.onclick = (e)=>{
    const gocat = e.target.getAttribute('data-gocat');
    if(gocat){ state.activeCat=gocat; render(); }

    const more = e.target.closest('[data-more]');
    if(more){
      const idx = Number(more.getAttribute('data-more'));
      const p = state.items[idx];
      mbody.innerHTML = 
        <div class="muted" style="margin-bottom:8px">${fmtDate(p.date)} • ${p.tags?.map(t=><span class="tag">#${esc(t)}</span>`).join(' ')||''}</div>
        <div style="font-weight:700;margin-bottom:8px">${esc(p.title||'بدون عنوان')}</div>
<div style="line-height:1.9;white-space:pre-wrap">${esc(p.caption||'')}</div>
        <div style="margin-top:14px"><a class="btn" href="${p.link}" target="_blank" rel="noopener">مشاهده در تلگرام</a></div>
      ;
      modal.classList.add('show');
    }
  };
}

function cardHTML(p, i){
  const cat = tagToCat(p.tags);
  const catTitle = CAT_TITLES[cat]||cat;
  const hasImg = !!p.thumb;
  const thumb = hasImg ? <img class="thumb" src="${esc(p.thumb)}" alt="">
                       : <div class="thumb" aria-hidden="true"></div>;
  return 
  <div class="card">
    ${thumb}
    <span class="badge">${esc('#'+catTitle.replace(/\s/g,'_'))}</span>
    <div class="ctxt">
      <div class="title">${esc(p.title||'بدون عنوان')}</div>
      <div class="row">
        <span>${fmtDate(p.date)}</span>
        <button class="btn" data-more="${i}">جزئیات</button>
      </div>
    </div>
  </div>;
}

function doSearch(){
  const q=(state.q||'').trim().toLowerCase();
  const box=document.getElementById('res');
  if(!q){ box.innerHTML='<div class="center">کلیدواژه را بنویسید…</div>'; return; }
  const res = state.items.filter(p=>{
    const t=((p.title||'')+' '+(p.caption||'')+' '+(p.tags||[]).join(' ')).toLowerCase();
    return t.includes(q);
  });
  box.innerHTML = res.map(cardHTML).join('') || <div class="center">نتیجه‌ای نبود.</div>;
}

// load data
async function load(){
  try{
    const r = await fetch(API_URL);
    const j = await r.json();
    const items = (j.items||[]).map(x=>({
      id:x.id, date:x.date, title:x.title, caption:x.caption,
      tags:Array.isArray(x.tags)? x.tags : String(x.tags||'').split(/\s+/).filter(Boolean),
      link:x.link, thumb:x.thumb // ممکن است نباشد
    }));
    state.items = items.sort((a,b)=> (b.date||0)-(a.date||0));
    // build categories
    const byCat={};
    for(const p of state.items){
      const c = tagToCat(p.tags);
      (byCat[c] ||= []).push(p);
    }
    state.byCat = byCat;
    render();
  }catch(e){
    app.innerHTML = <div class="center">خطا در بارگذاری API</div>`;
    console.error(e);
  }
}

// tabs
document.querySelectorAll('.tabbtn').forEach(b=>{
  b.onclick=()=>{
    state.tab = b.getAttribute('data-tab');
    render();
  };
});

render();
load();
</script>
</body>
</html>
