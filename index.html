<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Ø´Ø¨Ú©Ù‡ Ø³Ù„Ø§Ù…Øª</title>
<style>
  :root{
    --bg:#0f172a;
    --panel:#111827;
    --panel-2:#0b1220;
    --text:#e5e7eb;
    --muted:#93a3b8;
    --brand:#06b6d4;
    --brand-2:#22c55e;
    --chip:#1f2937;
    --danger:#ef4444;
    --shadow:0 8px 30px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b0f19;color:var(--text);}
  header{
    position:sticky;top:0;z-index:5;
    background:linear-gradient(90deg,#0ea5e9, #22c55e);
    color:#fff;
    padding:18px 16px;
    box-shadow:var(--shadow);
  }
  h1{margin:0;font-size:22px;display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
  h1 .logo{display:inline-grid;place-items:center;width:28px;height:28px;background:#fff2;border-radius:10px}
  .container{max-width:980px;margin:12px auto;padding:0 12px}
  .tabs{position:sticky;bottom:0;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;background:#0b0f19; padding:12px; border-top:1px solid #1f2937}
  .tab{appearance:none;border:none;border-radius:14px;padding:12px 8px;color:#cbd5e1;background:#0b192a; font-weight:700}
  .tab.active{background:linear-gradient(90deg,#0284c7,#06b6d4);color:#001827}
  .hidden{display:none}
  /* skeleton */
  .skeleton{height:12px;background:linear-gradient(90deg,#172033 25%,#1c2540 37%,#172033 63%);background-size:400% 100%;animation:shimmer 1.3s infinite; border-radius:999px}
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0}}
  /* grid */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  @media (max-width:680px){ .grid{grid-template-columns:repeat(2,1fr)} }
  .card{position:relative;overflow:hidden;border-radius:14px;background:#101826; box-shadow:var(--shadow);}
  .card img{display:block;width:100%;height:160px;object-fit:cover;background:#0b1220}
  .chip{position:absolute;top:8px;right:8px;background:#0009;color:#fff;font-size:12px;padding:6px 8px;border-radius:999px}
  .card .title{padding:10px;font-weight:700;font-size:14px;line-height:1.4;color:#e2e8f0}
  .card .meta{padding:0 10px 12px;font-size:12px;color:#9fb3c8}
  /* filters */
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
  .pill{background:#0c1627;border:1px solid #1f2940;color:#bcd0e8;padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
  .pill.active{background:#0ea5e9;color:#04111b;border-color:transparent}
  /* search */
  .search{display:flex;gap:8px;margin:8px 0 16px}
  .search input{flex:1;background:#0b1220;border:1px solid #1e293b;color:#dbeafe;padding:10px 12px;border-radius:12px}
  .search button{background:#0ea5e9;border:none;color:#002133;padding:10px 14px;border-radius:12px;font-weight:800}
  /* empty / error */
  .empty,.error{padding:16px;border-radius:12px;background:#0b1220;border:1px dashed #334155;color:#9fb3c8}
  .error{border-color:#7f1d1d;color:#fecaca}
  /* modal */
  dialog{border:0;border-radius:14px;background:#0b1220;color:#e5e7eb;max-width:640px;width:92vw}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .modal-img{width:100%;max-height:50vh;object-fit:cover;border-radius:10px}
  .modal-title{font-size:18px;margin:10px 0 6px}
  .modal-caption{white-space:pre-wrap;color:#c7d2fe}
  .close{margin-top:10px;background:#111827;border:1px solid #334155;border-radius:12px;padding:10px 14px;color:#cbd5e1}
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>
      <span class="logo">ğŸŒ¿</span>
      Ø´Ø¨Ú©Ù‡ Ø³Ù„Ø§Ù…Øª
    </h1>
    <div id="status" style="margin-top:6px;font-size:12px;opacity:.9"></div>
  </div>
</header>

<main class="container">
  <!-- HOME -->
  <section id="home">
    <div class="filters" id="homeFilters"></div>
    <div id="homeList" class="grid"></div>
  </section>

  <!-- EXPLORE -->
  <section id="explore" class="hidden">
    <div class="filters" id="catFilters"></div>
    <div class="grid" id="exploreGrid"></div>
    <div id="exploreEmpty" class="empty hidden">Ù¾Ø³ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>
  </section>

  <!-- SEARCH -->
  <section id="search" class="hidden">
    <div class="search">
      <input id="q" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†ØŒ Ú©Ù¾Ø´Ù† Ùˆ Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§â€¦">
      <button id="btnSearch">Ø¬Ø³ØªØ¬Ùˆ</button>
    </div>
    <div class="grid" id="searchGrid"></div>
    <div id="searchEmpty" class="empty hidden">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="hidden">
    <div class="empty">
      <b>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</b><br>
      Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡â€ŒÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§ Ø§ØªØµØ§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ù‡ Google Sheet (CSV) Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡. ØªØµØ§ÙˆÛŒØ± Ø§Ø² Google Drive Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
    </div>
  </section>
</main>

<!-- NAV -->
<nav class="tabs">
  <button class="tab" data-route="home">Ø®Ø§Ù†Ù‡</button>
  <button class="tab active" data-route="explore">Ø§Ú©Ø³Ù¾Ù„ÙˆØ±</button>
  <button class="tab" data-route="search">Ø¬Ø³ØªØ¬Ùˆ</button>
  <button class="tab" data-route="about">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</button>
</nav>

<!-- MODAL -->
<dialog id="viewer">
  <img class="modal-img" id="viewerImg" alt="">
  <div class="modal-title" id="viewerTitle"></div>
  <div class="modal-caption" id="viewerCap"></div>
  <button class="close" id="viewerClose">Ø¨Ø³ØªÙ†</button>
</dialog>

<script>
const CONFIG = {
  CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTc7k92da7KUDX60NbFQgsejpE5T7f2YS0My2p_E3RsXn2vM12PPqYTYaEm27mQLiEYLJkliLYMg3vS/pub?gid=1204797401&single=true&output=csv",
};

const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

const state = { items:[], cats:[], activeCat:"Ù‡Ù…Ù‡", loaded:false };

function setStatus(msg,type="") {
  const el = $("#status");
  el.textContent = msg || "";
  el.style.opacity = msg?1:.0;
}

function csvToRows(text){
  // Robust CSV parser (handles quoted commas and newlines)
  const rows=[]; let row=[], val=""; let q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='\"'){
      if(q && n==='\"'){ val+='\"'; i++; }
      else q=!q;
    } else if(c===',' && !q){ row.push(val); val=""; }
    else if((c==='\n' || c==='\r') && !q){
      if(val!=="" || row.length){ row.push(val); rows.push(row); row=[]; val=""; }
      if(c==='\r' && n==='\n') i++; // CRLF
    } else { val+=c; }
  }
  if(val!=="" || row.length){ row.push(val); rows.push(row); }
  return rows.filter(r=>r.some(c=>String(c).trim()!==''));
}

function norm(s){ return String(s||"").trim().toLowerCase(); }
function directDrive(url){
  if(!url) return "";
  try{
    const u=new URL(url);
    const idMatch = url.match(/[-\w]{25,}/);
    const id = idMatch? idMatch[0] : (u.searchParams.get("id")||"");
    if(id) return `https://drive.google.com/uc?export=view&id=${id}`;
  }catch(e){}
  return url;
}
function detectCols(headers){
  const map={img:null,title:null,cap:null,tags:null,cat:null,link:null,date:null};
  headers.forEach((h,i)=>{
    const x=norm(h);
    if(/(img|image|Ø¹Ú©Ø³|ØªØµÙˆÛŒØ±|ÙˆÛŒØ¯Ø¦Ùˆ)/.test(x)) map.img=i;
    else if(/(title|Ø¹Ù†ÙˆØ§Ù†)/.test(x)) map.title=i;
    else if(/(caption|ØªÙˆØ¶ÛŒØ­|Ú©Ù¾Ø´Ù†)/.test(x)) map.cap=i;
    else if(/(tag|Ù‡Ø´ØªÚ¯|Ø¨Ø±Ú†Ø³Ø¨)/.test(x)) map.tags=i;
    else if(/(Ø¯Ø³ØªÙ‡|category|Ú¯Ø±ÙˆÙ‡)/.test(x)) map.cat=i;
    else if(/(link|Ù„ÛŒÙ†Ú©|url)/.test(x)) map.link=i;
    else if(/(date|ØªØ§Ø±ÛŒØ®|Ø²Ù…Ø§Ù†)/.test(x)) map.date=i;
    // fallback: if sheet has "Column 2" from your previous transform, treat as image
    if(x.includes("column 2") && map.img==null) map.img=i;
  });
  return map;
}

function buildItems(rows){
  const [headers,...data]=rows;
  const cols=detectCols(headers);
  const required = cols.img!=null || cols.title!=null || cols.cap!=null;
  if(!required){ throw new Error("Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù†Ø¯. Ù„Ø·ÙØ§Ù‹ Ù‡Ø¯Ø±Ù‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."); }
  const items = data.map(r=>{
    const img = directDrive(r[cols.img]||"");
    const title = r[cols.title] || "";
    const cap = r[cols.cap] || "";
    const tags = String(r[cols.tags]||"").replace(/ØŒ/g,',').split(/[#,\s]+/).filter(Boolean);
    const cat = r[cols.cat] || (tags[0]||"Ù…ØªÙØ±Ù‚Ù‡");
    const link = r[cols.link] || "";
    const date = r[cols.date] || "";
    return {img,title,cap,tags,cat,link,date};
  }).filter(it=>it.img || it.title || it.cap);
  return items;
}

function cardTemplate(it, idx){
  const safeTitle = it.title || (it.tags?.[0] ? '#'+it.tags[0] : 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†');
  return `<article class="card" data-idx="${idx}">
    <span class="chip">${it.cat||"Ù…ØªÙØ±Ù‚Ù‡"}</span>
    <img loading="lazy" src="${it.img||''}" alt="">
    <div class="title">${safeTitle}</div>
    <div class="meta">${(it.tags||[]).slice(0,3).map(t=>'#'+t).join(' ')}</div>
  </article>`;
}

function renderExplore(){
  const grid = $("#exploreGrid");
  const empty = $("#exploreEmpty");
  const items = state.items.filter(it => state.activeCat==="Ù‡Ù…Ù‡" ? true : (norm(it.cat)===norm(state.activeCat)));
  grid.innerHTML = items.map((it,i)=>cardTemplate(it,i)).join("");
  empty.classList.toggle("hidden", items.length>0);
  grid.onclick = (e)=>{
    const card = e.target.closest(".card");
    if(!card) return;
    const it = items[Number(card.dataset.idx)] || items[0];
    openModal(it);
  };
}
function renderHome(){
  // Home: 6 Ø¢Ø®Ø±ÛŒÙ† Ù¾Ø³Øªâ€ŒÙ‡Ø§
  const list = $("#homeList");
  const items = state.items.slice(0,6);
  list.innerHTML = items.map((it,i)=>cardTemplate(it,i)).join("");
  list.onclick = (e)=>{
    const card = e.target.closest(".card");
    if(!card) return;
    const it = items[Number(card.dataset.idx)] || items[0];
    openModal(it);
  };
}
function renderCatFilters(){
  const cats = ["Ù‡Ù…Ù‡", ...state.cats];
  $("#catFilters").innerHTML = cats.map(c=>`<span class="pill ${c===state.activeCat?'active':''}" data-cat="${c}">${c}</span>`).join("");
  $("#catFilters").onclick = (e)=>{
    const p = e.target.closest(".pill"); if(!p) return;
    state.activeCat = p.dataset.cat;
    renderCatFilters(); renderExplore();
  };
}
function openModal(it){
  $("#viewerImg").src = it.img || "";
  $("#viewerTitle").textContent = it.title || "";
  $("#viewerCap").textContent = it.cap || "";
  $("#viewer").showModal();
}
function closeModal(){ $("#viewer").close(); }

function routeTo(name){
  $$(".tab").forEach(b=>b.classList.toggle("active", b.dataset.route===name));
  ["home","explore","search","about"].forEach(id=>$("#"+id).classList.toggle("hidden", id!==name));
  location.hash = name;
}
function bindNav(){
  $$(".tab").forEach(b=> b.onclick = ()=> routeTo(b.dataset.route) );
  $("#viewerClose").onclick = closeModal;
  window.addEventListener("keydown",e=>{ if(e.key==="Escape") closeModal(); });
  window.addEventListener("hashchange",()=>{
    const h=location.hash.replace("#","")||"explore";
    routeTo(h);
  });
}

async function loadCSV(){
  setStatus("Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§â€¦");
  const res = await fetch(CONFIG.CSV_URL, {cache:"no-store"});
  if(!res.ok) throw new Error("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ CSV Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.");
  const text = await res.text();
  const rows = csvToRows(text);
  const items = buildItems(rows);
  state.items = items;
  state.cats = Array.from(new Set(items.map(it=>it.cat).filter(Boolean)));
  state.loaded = true;
  setStatus(`ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø³Øªâ€ŒÙ‡Ø§: ${items.length}`);
  // render
  renderCatFilters();
  renderExplore();
  renderHome();
}

function doSearch(){
  const q = norm($("#q").value);
  const grid = $("#searchGrid");
  const empty = $("#searchEmpty");
  const items = state.items.filter(it=>{
    const hay=[it.title,it.cap, ...(it.tags||[])].join(" ").toLowerCase();
    return hay.includes(q);
  });
  grid.innerHTML = items.map((it,i)=>cardTemplate(it,i)).join("");
  empty.classList.toggle("hidden", items.length>0);
  grid.onclick = (e)=>{
    const card = e.target.closest(".card");
    if(!card) return;
    const it = items[Number(card.dataset.idx)] || items[0];
    openModal(it);
  };
}

function init(){
  bindNav();
  $("#btnSearch").onclick = doSearch;
  $("#q").addEventListener("keydown",e=>{ if(e.key==="Enter") doSearch(); });
  const route = (location.hash||"#explore").replace("#","");
  routeTo(route);
  // show quick skeletons
  $("#exploreGrid").innerHTML = `<div class="skeleton" style="height:160px;border-radius:14px"></div>`.repeat(6);
  loadCSV().catch(err=>{
    console.error(err);
    setStatus("");
    const box = document.createElement("div");
    box.className="error";
    box.innerHTML = "Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: "+ err.message + "<br>Ù„Ø·ÙØ§Ù‹ Ù„ÛŒÙ†Ú© CSV Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ù†ØªØ´Ø§Ø± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.";
    $(".container").prepend(box);
  });
}

init();
</script>
</body>
</html>
