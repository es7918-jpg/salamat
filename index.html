<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>شبکه سلامت – بله</title>
<style>
body{font-family:tahoma,arial,sans-serif;background:#f7fafc;color:#111;max-width:980px;margin:0 auto;padding:16px;padding-bottom:80px}
.top{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.badge{background:#0ea5e9;color:#fff;border-radius:999px;padding:4px 8px;font-size:12px}
.tabs{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e7eb;display:flex;gap:8px;justify-content:space-around;padding:10px}
.tabbtn{background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:8px 14px;cursor:pointer}
.tabbtn.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
.body{padding:12px}
.title{font-weight:700;margin:0 0 6px}
.cap{font-size:13px;color:#374151;line-height:1.8;white-space:pre-wrap}
.muted{color:#64748b;font-size:12px}
input.search{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;margin:8px 0}
.catgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.catbtn{border:0;border-radius:16px;color:#fff;text-align:right;padding:16px;cursor:pointer;display:flex;flex-direction:column;gap:6px;min-height:100px}
.catbtn small{opacity:.9}
.cat-mental{background:linear-gradient(135deg,#06b6d4,#0ea5e9)}
.cat-nutrition{background:linear-gradient(135deg,#22c55e,#84cc16)}
.cat-dental{background:linear-gradient(135deg,#6366f1,#a78bfa)}
.cat-disease{background:linear-gradient(135deg,#f43f5e,#fb923c)}
.cat-family{background:linear-gradient(135deg,#ec4899,#f472b6)}
.back{border:1px solid #e5e7eb;border-radius:999px;background:#fff;padding:6px 12px;cursor:pointer;margin-bottom:12px}
.headerrow{display:flex;gap:10px;align-items:center;margin:8px 0 12px}
.hashtags{margin-top:6px}
.hashtags span{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;font-size:11px;margin:2px}
</style>
</head>
<body>
  <div class="top"><h1 style="margin:0">شبکه سلامت</h1><span class="badge">Bale API</span></div>
  <main id="app"></main>

  <nav class="tabs">
    <button class="tabbtn" data-tab="home">خانه</button>
    <button class="tabbtn" data-tab="explore">اکسپلور</button>
    <button class="tabbtn" data-tab="search">جستجو</button>
    <button class="tabbtn" data-tab="about">درباره ما</button>
  </nav>

<script>
const API_URL = "PASTE_YOUR_APPS_SCRIPT_EXEC_URL_HERE"; // ← لینک Web App خودت

const CAT_TITLES = {
  mental:"سلامت روان", nutrition:"تغذیه",
  dental:"دهان و دندان", disease:"بیماری‌ها", family:"سلامت خانواده"
};
const TAG_MAP = {
  'سلامت_روان':'mental','mental':'mental',
  'تغذیه':'nutrition','nutrition':'nutrition',
  'دهان_و_دندان':'dental','dental':'dental',
  'بیماری_ها':'disease','بیماریها':'disease','disease':'disease',
  'سلامت_خانواده':'family','family':'family'
};
const state = { tab:'home', activeCat:null, lists:{mental:[],nutrition:[],dental:[],disease:[],family:[]}, explore:[], searchPool:[], q:'' };
const app = document.getElementById('app');

function esc(s){return String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function cut(s,n){return s && s.length>n ? s.slice(0,n)+'…' : (s||'')}
function normTag(t){return String(t||'').replace(/^#/,'').trim().replace(/ي/g,'ی').replace(/ك/g,'ک').replace(/\s+/g,'_').replace(/[\u200c\-–—]+/g,'_')}
function extractTags(txt){
  if(!txt) return [];
  const re = /(^|\s)#([A-Za-z0-9_\u0600-\u06FF]+)/g; const out=[]; let m;
  while((m=re.exec(txt))) out.push(normTag(m[2]));
  return out;
}
function detectCat(tags){
  for(let t of tags){ if(TAG_MAP[t]) return TAG_MAP[t]; }
  return '';
}
state.lists = lists;
    state.explore = cooked;
    state.searchPool = cooked;
    render();
  }catch(err){
    app.innerHTML = '<div class="muted">خطا در خواندن API</div>';
    console.error(err);
  }
}

// تب‌ها
document.querySelectorAll('.tabs .tabbtn').forEach(btn=>{
  btn.onclick=()=>{ const t=btn.dataset.tab; state.tab=t; if((t==='explore'||t==='search') && !state.explore.length) load(); render(); };
});

render();
load();
</script>
</body>
</html>
function renderCards(list, showCat){
  if(!list.length) return '<div class="muted" style="margin-top:8px">چیزی برای نمایش نیست.</div>';
  return '<div class="grid">'+list.map(p=>{
    const when = p.date ? new Date(p.date*1000).toLocaleString('fa-IR') : '';
    const tags = (p.tags||[]).map(t=><span>#${esc(t)}</span>).join('');
    const cat = showCat && p.cat ? <span class="muted">${CAT_TITLES[p.cat]||''}</span> : '';
    // اگر بعداً لینک عکس/ویدئو اضافه کردی، اینجا میشه <img> یا <video> گذاشت.
    return <article class="card"><div class="body">
      <h3 class="title">${esc(p.title||p.text?.split('\n')[0]||('پست '+p.id))}</h3>
      ${p.text? <p class="cap">${esc(cut(p.text, 500))}</p>:''}
      <div class="hashtags">${tags}</div>
      <div class="muted" style="margin-top:8px">${esc(when)} ${cat}</div>
    </div></article>;
  }).join('')+'</div>';
}

function render(){
  let html="";
  if(state.tab==='home'){
    if(!state.activeCat){
      html += '<h2 style="margin:6px 0 12px">دسته‌ها</h2><div class="catgrid">'
           +  '<button class="catbtn cat-mental" data-gocat="mental"><small>ورود به</small><strong>سلامت روان</strong></button>'
           +  '<button class="catbtn cat-nutrition" data-gocat="nutrition"><small>ورود به</small><strong>تغذیه</strong></button>'
           +  '<button class="catbtn cat-dental" data-gocat="dental"><small>ورود به</small><strong>دهان و دندان</strong></button>'
           +  '<button class="catbtn cat-disease" data-gocat="disease"><small>ورود به</small><strong>بیماری‌ها</strong></button>'
           +  '<button class="catbtn cat-family" data-gocat="family"><small>ورود به</small><strong>سلامت خانواده</strong></button>'
           +  '</div>';
    }else{
      const k=state.activeCat, lst=state.lists[k]||[];
      html += '<div class="headerrow"><button class="back" data-back="1">← بازگشت</button><h2 style="margin:0">'+(CAT_TITLES[k]||k)+'</h2></div>'
           +  (lst.length? renderCards(lst,false) : '<div class="muted">در حال بارگذاری…</div>');
    }
    app.innerHTML=html;
  }else if(state.tab==='explore'){
    app.innerHTML = (state.explore.length? renderCards(state.explore,true) : '<div class="muted">در حال بارگذاری…</div>');
  }else if(state.tab==='search'){
    html += '<input class="search" id="q" placeholder="جستجو در متن/کپشن…">';
    const q=state.q.trim().toLowerCase();
    const results = q? state.searchPool.filter(p=>((p.title||'')+' '+(p.text||'')).toLowerCase().includes(q)) : [];
    html += q? <div class="muted" style="margin:6px 0">${results.length} نتیجه</div> : '<div class="muted" style="margin:6px 0">کلیدواژه بنویسید…</div>';
    html += renderCards(results,true);
    app.innerHTML = html;
    const qi=document.getElementById('q'); if(qi){ qi.value=state.q; qi.oninput=()=>{state.q=qi.value; render();}; }
  }else{
    app.innerHTML = '<div class="card"><div class="body"><h3 class="title">درباره ما</h3><p class="cap">پست‌ها از کانال بله خوانده می‌شوند. دسته‌بندی بر اساس #هشتگ انجام می‌شود.</p></div></div>';
  }
  document.querySelectorAll('.tabs .tabbtn').forEach(b=>{const t=b.dataset.tab; b.className='tabbtn'+(t===state.tab?' active':'')});
  app.onclick = (e)=>{
    const k=e.target.getAttribute('data-gocat'); if(k){ state.activeCat=k; render(); return; }
    if(e.target.getAttribute('data-back')){ state.activeCat=null; render(); }
  };
}

async function load(){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    // انتظار: data.items → همون چیزی که از اسکریپت می‌فرستی (id, text, date)
    const raw = data.items || [];

    // استخراج هشتگ و دسته
    const cooked = raw.map(it=>{
      const tags = extractTags(it.text||'');
      const cat  = detectCat(tags);
      return {
        id: it.id, text: it.text||'', date: it.date||null,
        title: it.text ? it.text.split('\n')[0].slice(0,100) : '',
        tags, cat
      };
    });

    // پر کردن دسته‌ها
    const lists = {mental:[],nutrition:[],dental:[],disease:[],family:[]};
    cooked.forEach(p=>{
      if(p.cat && lists[p.cat]) lists[p.cat].push(p);
    });
