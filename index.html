<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>شبکه سلامت – اتصال به تلگرام</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ color-scheme: light dark; }
    html,body{ background:#0b1220; color:#e7eef7; }
    .card{ background:#0f172a; border:1px solid #1e293b; }
    .muted{ color:#93a4b8 }
    .chip{ background:#0b253a; border:1px solid #1f3a57 }
    .tabbtn{ background:#0b253a; border:1px solid #1f3a57 }
    .tabbtn.active{ background:#0284c7; border-color:#0284c7; color:#fff }
    .btn{ background:#0284c7 }
  </style>

  <meta name="theme-color" content="#0b1220">
  <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body class="max-w-screen-md mx-auto min-h-[100svh] pb-24 px-4">

  <header class="py-5">
    <h1 class="text-2xl font-extrabold">شبکه سلامت</h1>
    <p class="muted">نسخه آزمایشی – اتصال به تلگرام</p>
  </header>

  <main id="app" class="space-y-4"></main>

  <nav class="fixed inset-x-0 bottom-0 z-50">
    <div class="mx-auto max-w-screen-md bg-[#0f172a]/80 backdrop-blur-xl border-t border-slate-700">
      <div class="grid grid-cols-4 gap-2 p-2">
        <button class="tabbtn rounded-xl py-2 text-sm" data-tab="home">خانه</button>
        <button class="tabbtn rounded-xl py-2 text-sm" data-tab="explore">اکسپلور</button>
        <button class="tabbtn rounded-xl py-2 text-sm" data-tab="search">جستجو</button>
        <button class="tabbtn rounded-xl py-2 text-sm" data-tab="about">درباره ما</button>
      </div>
    </div>
  </nav>

  <script>
  const API_URL = "https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec";
  const CAT_TAGS = {
    "سلامت روان": ["#سلامت_روان","#روان"],
    "تغذیه": ["#تغذیه","#رژیم","#غذا"],
    "دهان و دندان": ["#دهان_و_دندان","#دندان"],
    "بیماری‌ها": ["#بیماری","#بیماری‌ها","#پیشگیری"],
    "سلامت خانواده": ["#خانواده","#بارداری","#کودک"]
  };

  const state = { tab: "home", items: [], byCat: {}, activeCat: null, q: "" };
  const app = document.getElementById('app');

  const esc = s => (s??"").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
  const cut = (s,n)=> !s? "" : (s.length>n? (s.slice(0,n)+"…") : s);

  async function loadData(){
    try{
      const r = await fetch(API_URL, {cache:"no-store"});
      if(!r.ok) throw new Error("API "+r.status);
      const json = await r.json();
      const items = (json.items || []).map(x=>{
        const tags = Array.isArray(x.tags)
            ? x.tags
            : (x.tags||"").split(/[,\s]+/).filter(Boolean);
        return {
          id: x.id ?? "",
          date: x.date ?? "",
          title: x.title ?? "",
          caption: x.caption ?? "",
          tags,
          link: x.link ?? ""
        };
      });
      items.sort((a,b)=> new Date(b.date) - new Date(a.date));
      state.items = items;
      buildCategories();
      render();
    }catch(e){
      app.innerHTML = `<div class="card rounded-2xl p-5"><div class="text-red-400 font-bold mb-2">خطا در دریافت داده‌ها</div><div class="muted text-sm">${esc(e.message)}</div></div>`;
    }
  }

  function buildCategories(){
    const byCat = {};
    Object.keys(CAT_TAGS).forEach(cat => byCat[cat] = []);
    for(const p of state.items){
      for(const [cat, tags] of Object.entries(CAT_TAGS)){
        if (p.tags.some(t => tags.includes(t))) byCat[cat].push(p);
      }
    }
    state.byCat = byCat;
  }

  function postCards(list, showCatBadge=false){
    if(!list?.length) return '<div class="muted text-sm px-1">چیزی برای نمایش نیست.</div>';
    return list.map(p=>{
      const dateTxt = p.date ? new Date(p.date).toLocaleString('fa-IR') : '';
      const tagsHtml = (p.tags||[]).slice(0,5).map(t=>`<span class="chip inline-block text-xs px-2 py-1 rounded-lg me-1 mb-1">${esc(t)}</span>`).join('');
      const catBadge = showCatBadge ? `<span class="chip text-xs px-2 py-1 rounded-lg">${findCatFor(p) || "متفرقه"}</span>` : '';
      return `<article class="card rounded-2xl p-4">
        <div class="flex items-center justify-between"><h3 class="font-bold text-base">${esc(p.title || "بدون عنوان")}</h3>${catBadge}</div>
        <p class="muted mt-1 text-sm">${esc(cut(p.caption,220))}</p>
        <div class="mt-3">${tagsHtml}</div>
        <div class="flex items-center justify-between mt-4">
          <span class="muted text-xs">${esc(dateTxt)}</span>
          <a class="btn text-sm px-3 py-2 rounded-xl" target="_blank" rel="noopener" href="${esc(p.link)}">مشاهده در تلگرام</a>
        </div>
      </article>`;
    }).join('');
  }

  function findCatFor(p){
    for(const [cat,tags] of Object.entries(CAT_TAGS)){
      if(p.tags?.some(t=>tags.includes(t))) return cat;
    }
    return null;
  }

  function render(){
    document.querySelectorAll('.tabbtn').forEach(b=>{
      const t = b.getAttribute('data-tab');
      b.className = 'tabbtn rounded-xl py-2 text-sm' + (t===state.tab ? ' active' : '');
    });

    if(state.tab === 'home'){
      if(!state.activeCat){
        const cats = Object.keys(CAT_TAGS);
        app.innerHTML = `<section class="space-y-3"><h2 class="text-lg font-bold">دسته‌بندی‌ها</h2>
          <div class="flex flex-wrap gap-2">${cats.map(c=>`<button class="chip px-3 py-2 rounded-xl" data-gocat="${esc(c)}">${esc(c)}</button>`).join('')}</div></section>`;
        app.querySelectorAll('[data-gocat]').forEach(el=>{ el.onclick = ()=>{ state.activeCat = el.getAttribute('data-gocat'); render(); }; });
      }else{
        const back = `<div class="flex items-center gap-3 mb-3"><button class="tabbtn rounded-xl px-3 py-2 text-sm" id="backHome">← بازگشت</button><h2 class="text-lg font-bold m-0">${esc(state.activeCat)}</h2></div>`;
        const list = state.byCat[state.activeCat] || [];
        app.innerHTML = back + postCards(list);
        document.getElementById('backHome').onclick = ()=>{ state.activeCat=null; render(); };
      }
    }
    else if(state.tab === 'explore'){
      app.innerHTML = `<h2 class="text-lg font-bold">اکسپلور</h2>${postCards(state.items,true)}`;
    }
    else if(state.tab === 'search'){
      const q = state.q.trim().toLowerCase();
      const list = !q ? [] : state.items.filter(p=>{ const hay = (p.title+" "+p.caption+" "+(p.tags||[]).join(" ")).toLowerCase(); return hay.includes(q); });
      app.innerHTML = `<div class="card rounded-2xl p-4"><input id="q" class="w-full bg-transparent outline-none border border-slate-700 rounded-xl px-4 py-3" placeholder="جستجو…" value="${esc(state.q)}"></div><div class="mt-4">${postCards(list,true)}</div>`;
      document.getElementById('q').oninput = e=>{ state.q = e.target.value; render(); };
    }
    else if(state.tab === 'about'){
      app.innerHTML = `<section class="card rounded-2xl p-5 space-y-3"><h2 class="text-lg font-bold">درباره ما</h2><p class="muted leading-7">این نسخه‌ی آزمایشی، پست‌های کانال تلگرام را از طریق Google Apps Script خوانده و با رابط کاربری موبایلی نمایش می‌دهد.</p></section>`;
    }
  }

  document.querySelectorAll('.tabbtn').forEach(btn=>{ btn.onclick = ()=>{ state.tab = btn.getAttribute('data-tab'); render(); }; });
  render(); loadData();
  </script>
</body>
</html>
